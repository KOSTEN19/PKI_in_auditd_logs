# –ó–∞—â–∏—Ç–∞ –∂—É—Ä–Ω–∞–ª–æ–≤ –∞—É–¥–∏—Ç–∞ —Å –ø–æ–º–æ—â—å—é PKI –¥–ª—è ALT Linux

–≠—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫—É—é –∑–∞—â–∏—Ç—É –∂—É—Ä–Ω–∞–ª–æ–≤ `auditd` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–ª—é—á–µ–π (PKI) —Å OpenSSL/GPG.

## üìú –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
- [–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π](#-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è-–∫–ª—é—á–µ–π)
- [–£—Å—Ç–∞–Ω–æ–≤–∫–∞](#-—É—Å—Ç–∞–Ω–æ–≤–∫–∞)
- [–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ](#-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ)

---

## üîê –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π

### –ö–ª—é—á–∏ OpenSSL (RSA)
```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–æ–≥–æ –∫–ª—é—á–∞ (–∑–∞—â–∏—â–µ–Ω–Ω–æ–≥–æ –ø–∞—Ä–æ–ª–µ–º)
openssl genpkey -algorithm RSA -out /etc/audit/private/auditd_private_key.pem -aes256

# –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –∫–ª—é—á–∞
openssl rsa -pubout -in /etc/audit/private/auditd_private_key.pem -out /etc/audit/auditd_public_key.pem

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
chown root:auditd /etc/audit/private/auditd_private_key.pem
chmod 640 /etc/audit/private/auditd_private_key.pem
```

## üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞
### –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –≤ /usr/local/bin/auditd_secure_logs.sh:

```bash
#!/bin/bash
# –®–∏—Ñ—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –∂—É—Ä–Ω–∞–ª—ã –≤—ã—Å–æ–∫–æ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç >= 4)
INPUT_LOG="$1"
OUTPUT_DIR="/var/log/audit/secure"
MIN_PRIORITY=4
KEY_UPDATE_INTERVAL=3600  # –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –∫–ª—é—á–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (1 —á–∞—Å)

# –ü—É—Ç—å –∫ –æ—Ç–∫—Ä—ã—Ç—ã–º –∏ –∑–∞–∫—Ä—ã—Ç—ã–º –∫–ª—é—á–∞–º
PUBLIC_KEY="/etc/audit/auditd_public.pem"
PRIVATE_KEY="/etc/audit/private/auditd_private.pem"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –∫–ª—é—á–∞
update_public_key() {
  # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –∫–ª—é—á–∞ –∏–∑ –∑–∞–∫—Ä—ã—Ç–æ–≥–æ
  openssl ec -in "$PRIVATE_KEY" -pubout -out "$PUBLIC_KEY"
  echo "–û—Ç–∫—Ä—ã—Ç—ã–π –∫–ª—é—á –æ–±–Ω–æ–≤–ª–µ–Ω: $PUBLIC_KEY"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª—é—á–∞
if [ ! -f "/etc/audit/last_key_update" ]; then
  touch "/etc/audit/last_key_update"
  echo "0" > "/etc/audit/last_key_update"
fi

LAST_UPDATE=$(cat /etc/audit/last_key_update)
CURRENT_TIME=$(date +%s)

if (( CURRENT_TIME - LAST_UPDATE >= KEY_UPDATE_INTERVAL )); then
  update_public_key
  echo "$CURRENT_TIME" > "/etc/audit/last_key_update"
fi

[ "$(id -un)" = "auditd" ] || { echo "–î–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –æ—Ç –∏–º–µ–Ω–∏ auditd" >&2; exit 1; }

process_line() {
  local line="$1"
  local pri=$(echo "$line" | grep -oP 'priority=\K\d+')
  
  if [ -n "$pri" ] && [ "$pri" -ge "$MIN_PRIORITY" ]; then
    # –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –≤—ã—Å–æ–∫–æ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
    TEMP_KEY=$(openssl rand -hex 32)
    echo "$line" | openssl enc -aes-256-cbc -salt -pass pass:"$TEMP_KEY" | \
      openssl rsautl -encrypt -pubin -inkey "$PUBLIC_KEY" > \
      "${OUTPUT_DIR}/$(date +%s).enc"
    echo "$TEMP_KEY" | openssl rsautl -sign -inkey "$PRIVATE_KEY" >> \
      "${OUTPUT_DIR}/$(date +%s).key"
  else
    # –ü—Ä–æ–ø—É—Å–∫ –∑–∞–ø–∏—Å–µ–π –Ω–∏–∑–∫–æ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
    echo "$line"
  fi
}

mkdir -p "$OUTPUT_DIR"
while IFS= read -r line; do
  process_line "$line"
done < "$INPUT_LOG"
```


### –°–¥–µ–ª–∞–π—Ç–µ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º:

```bash
chmod +x /usr/local/bin/auditd_secure_logs.sh
chown auditd:auditd /usr/local/bin/auditd_secure_logs.sh
```


### –ù–∞—Å—Ç—Ä–æ–π—Ç–µ auditd –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞:

```bash
echo '-w /var/log/audit/audit.log -p wa -k secure_audit_log -x /usr/local/bin/auditd_secure_logs.sh' > /etc/audit/rules.d/secure_logs.rules
service auditd restart
```



# üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
## –°–∫—Ä–∏–ø—Ç –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
–°–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –∂—É—Ä–Ω–∞–ª—ã –≤ /var/log/audit/secure/

–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª–µ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∏ (.sig)

–°–∂–∏–º–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∂—É—Ä–Ω–∞–ª—ã
# –†–∞c—à–∏—Ñ—Ä–æ–≤–∫–∞

```bash
#!/bin/bash

INPUT_FILE="$1"
OUTPUT_FILE="$2"
PRIVATE_KEY="/etc/audit/private/auditd_private.pem"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
if [ ! -f "$INPUT_FILE" ]; then
  echo "–í—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!" >&2
  exit 1
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
> "$OUTPUT_FILE"

while IFS= read -r line; do
  # –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
  ENCRYPTED_DATA=$(echo "$line" | openssl rsautl -decrypt -inkey "$PRIVATE_KEY")
  
  # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–∏ –∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
  TIMESTAMP=$(echo "$ENCRYPTED_DATA" | cut -d':' -f1)
  ENCRYPTED_LINE=$(echo "$ENCRYPTED_DATA" | cut -d':' -f2-)

  # –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞
  TEMP_KEY=$(cat "${OUTPUT_DIR}/$(basename "$line" .enc).key" | openssl rsautl -decrypt -inkey "$PRIVATE_KEY")
  DECRYPTED_LINE=$(echo "$ENCRYPTED_LINE" | openssl enc -d -aes-256-cbc -pass pass:"$TEMP_KEY")

  # –ó–∞–ø–∏—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π –≤ –≤—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª
  echo "$TIMESTAMP: $DECRYPTED_LINE" >> "$OUTPUT_FILE"
done < "$INPUT_FILE"

echo "–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ $OUTPUT_FILE."
```
